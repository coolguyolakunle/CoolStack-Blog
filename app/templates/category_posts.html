{% extends "base.html" %}
{% block content %}
<div class="category-page">
  <h2 class="category-title">Posts in <span>{{ category_name }}</span></h2>

  {% if posts %}
  {% for post in posts %}
    <div class="post">
        <div class="post-header">
            <img src="{{ url_for('static', filename='uploads/profile_pics/' ~ post.author.profile_pic) }}" class="avatar">
            <div class="author-info">
                <div class="full-date">
                    <h1 class="fullname">{{ post.author.fullname }}</h1>
                    <span class="full date" data-time="{{ post.date_posted.isoformat() }}Z"></span>
                </div>
                <a href="{{ url_for('main.view_profile', username=post.author.username) }}" class="username">@{{ post.author.username }}</a>
            </div>
        </div>

        <!-- Clickable Post Title -->
        <a href="{{ url_for('main.view_post', post_id=post.id) }}" class="post-link">
            <h3>{{ post.title }}</h3>
            <p>{{ post.content[:200] }}{% if post.content|length > 200 %}...{% endif %}</p>

            {% if post.image %}
            <img src="{{ url_for('static', filename='uploads/post_images/' ~ post.image) }}" class="post-image">
            {% endif %}

        </a>

        {% if post.video %}
        <div class="video_container">
            <video class="post_video" controls>
            <source src="{{ url_for('static', filename='uploads/post_videos/' ~ post.video) }}" type="video/mp4">
            Your browser does not support the video tag.
            </video>
            <div class="play-overlay">
            <i class="fas fa-play"></i>
            </div>
        </div>
        {% endif %}

        <p class="post-category">
            Category:
            <a href="{{ url_for('main.category_posts', category_name=post.category) }}">
            {{ post.category }}
            </a>
        </p>

        <div class="post-footer">
            <div class="post-like-comment">
                <button class="like-btn" data-post-id="{{ post.id }}">
                    ❤️ <span id="like-count-{{ post.id }}">{{ post.likes|length }}</span>
                </button>

                <a href="#" class="comment-btn" data-post-id="{{ post.id }}"><i class="fas fa-comment-dots"></i>
                {{ post.comments|length }}</a>
            </div>
            
            <!-- <span class="date" data-time="{{ post.date_posted.isoformat() }}"></span> -->

            {% if current_user.is_authenticated and post.user_id == current_user.id %}
            <!-- DELETE BUTTON -->
            <form method="POST" action="{{ url_for('main.delete_post', post_id=post.id) }}" class="delete-post-form">
                <input type="hidden" name="csrf_token" value="{{ csrf_token() }}">
                <button type="button" class="delete" data-post-id="{{ post.id }}"><i class="fas fa-trash"></i></button>
            </form>

            <!-- CUSTOM CONFIRMATION MODAL -->
            <div id="deleteConfirmModal" class="del-modal-overlay" style="display: none;">
                <div class="del-modal-content">
                    <h3>Are you sure?</h3>
                    <p>This action cannot be undone.</p>
                    <div class="del-modal-buttons">
                        <button id="confirmDeleteBtn">Yes, delete</button>
                        <button id="cancelDeleteBtn">Cancel</button>
                    </div>
                </div>
            </div>

            {% endif %}
        </div>
    </div>
  {% endfor %}
  {% else %}
  <p>No posts found in this category yet.</p>
  {% endif %}
</div>

<!-- COMMENT MODAL -->
<div id="commentModal" class="modal">
  <div class="modal-content">
    <span class="close">&times;</span>
    <div id="commentSection" class="comment-section">
      <p>Loading comments...</p>
    </div>
  </div>
</div>

{% endblock %}
